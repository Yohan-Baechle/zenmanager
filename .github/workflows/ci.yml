  name:  CI 

  on: 
    push: 
      branches: [main, develop]
    pull_request:
      branches: [main, develop]

  jobs:
    backend:
      name: Symfony Backend
      runs-on: ubuntu-latest
      defaults:
        run:
          working-directory: ./backend
      steps:
        - uses: actions/checkout@v4

        - name: Set up PHP
          uses: shivammathur/setup-php@v2
          with:
            php-version: '8.3'
            extensions: mbstring, intl, pdo_mysql
            coverage: none

        - name: Install Composer dependencies
          run: composer install --no-scripts --no-interaction --no-progress --prefer-dist

        # the best practice *for symfony* is to create a .env.test file
        # but to keep the repo clean and for ci/cd experimenting reason (I'm here to learn about it), we create a .env file here 
        # for now the file is tiny so it's not a big deal, but we'll change that if the file grows 
        - name: Create .env file
          run: |
            echo "APP_ENV=test" > .env
            echo "APP_SECRET=dummy_secret" >> .env
            echo "DATABASE_URL=sqlite:///%kernel.project_dir%/var/data.db" >> .env
            echo "DEFAULT_URI=http://localhost" >> .env

        #just a sanity check but apparently useful in early projects
        - name: Check Symfony boot and console
          run: |
            php bin/console cache:clear --no-warmup 
            php bin/console about

        #check we're not missing any env variables
        - name: Check Symfony container is valid
          run: php bin/console lint:container

        #- name: Run Doctrine migrations
        #  run: php bin/console doctrine:migrations:migrate --no-interaction

        - name: Check routes
          run: php bin/console debug:router

        - name: Run PHPUnit tests (Entities only)
          run: php bin/phpunit tests/Entity/UserTest.php
          
        - name: Run PHPUnit tests
          run: |
            php bin/phpunit --testdox

        